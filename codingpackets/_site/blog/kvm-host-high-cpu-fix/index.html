


<!DOCTYPE html>
<html lang="en" class="dark scroll-smooth scroll-pt-[4.5rem]">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    
      <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon">
    
    
    
      <link rel="stylesheet" href="/css/highlightjs/highlightjs-xt256.css">
      <link rel="stylesheet" href="/css/fontawesome/css/all.min.css">
    

    
      <link rel="stylesheet" href="/css/app.css">
    

    
      <script src="/js/highlightjs/highlightjs-11.5.0.min.js"></script>
      <script src="/js/highlightjs/terraform.js"></script>
      <script defer src="/js/fontawesome/js/all.js"></script>
    

    
      <script defer src="/js/custom/back-to-top.js"></script>
      <script defer src="/js/custom/light-switch.js"></script>
    

    
      <script>
        hljs.registerLanguage('terraform', window.hljsDefineTerraform);
        hljs.highlightAll();
      </script>
    

    
    

    <title>codingpackets.com</title>
  </head>

  <body class="bg-stone-50 dark:bg-black leading-normal tracking-wide ">

    <!-- NAVBAR START -->
<nav id="navbar" class="w-full py-3 bg-zinc-900 text-xl shadow-lg fixed inset-x-0 top-0 z-50">
  <div class="flex justify-center items-center py-1">
    <div>
      <a class="text-neutral-400 hover:text-neutral-100 p-0" href="/">Me</a>
    </div>
    <div class="px-4">
      <p class="text-neutral-400 p-0">|</p>
    </div>
    <div>
      <a class="text-neutral-400 hover:text-neutral-100" href="/blog/">Blog</a>
    </div>
    <div class="px-4">
      <p class="text-neutral-400 p-0">|</p>
    </div>
    <div>
      <a class="text-neutral-400 hover:text-neutral-100" href="/blog/recent/">Recent</a>
    </div>
    <div class="px-4">
      <p class="text-neutral-400 p-0">|</p>
    </div>
    <div class="-mt-6 -ml-1">
      <labeL class="relative inline-block">
        <input type="checkbox" id="light-switch" class="opacity-0 w-0 h-0">
        <img id="light-bulb" class="opacity-90 hover:opacity-60 dark:opacity-60 dark:hover:opacity-100 p-0 w-7" src="/img/light-bulb-64-light.png" alt="on/off">
      </labeL>
    </div>
  </div>  
</nav>
<!-- NAVBAR END -->

    <div class="w-full">
      
  
    
<!-- PAGE HEADER START -->
<div id="page-header" class="pt-20 -mb-4 pb-0 px-5 text-center sm:pb-4 sm:mb-0">
  <h1 class="pb-1 sm:pb-2">KVM Host High CPU Fix</h1>
  <div class="">
    
      <p class="text-neutral-400 dark:text-neutral-600 text-lg italic p-0">
        updated: 26th of January 2019
      </p>
    
    
      <p class="text-neutral-400 dark:text-neutral-600 text-lg italic p-0">
        published: 8th of September 2018
      </p>
    
  </div>
</div>
<!-- PAGE HEADER END -->

  


      <!-- CONTENT START -->
      <div class="grid grid-cols-12 gap-8">

        <!-- COLUMN 1 START -->
        <div class="invisible md:visible md:col-span-3">
        </div>
        <!-- COLUMN 1 END -->

        <!-- COLUMN 2 START -->
        <div class="col-span-12 px-5 md:col-span-6">
          <div class="text-xl text-gray-800 dark:text-neutral-400 font-medium">
            

<h3 id="intro">Intro</h3>
<p>
  I run my labs on an Ubuntu 1604 host using KVM for the hypervisor and some of the network
  VM images (Cisco CRS1000v, Juniper vMX, etc..) run with very high CPU. A recent thread on
  Twitter helped me to find a solution to this problem so I will outline it here as it may
  be helpful for others.
</p>

<p>
  For reference the following software was used in this post.
</p>
<ul>
  <li><b>Ubuntu</b> - 1604</li>
  <li><b>KVM</b> - 2.5.0</li>
</ul>

<h3 id="the-question">The Question</h3>
<p>
  Tony E <a class="text-sky-600 no-underline hover:text-sky-800" href="https://twitter.com/showipintbri" target=_blank>@showipintbri</a> asked the following
  question to the twitterverse regarding running the CSR1000v in eve-ng (which uses KVM as
  its hypervisor).
</p>


<!-- IMAGE START -->
<div class="pt-4 pb-6 flex justify-center">
  <img class="bg-white rounded-lg shadow-md shadow-zinc-400 dark:opacity-80 dark:shadow-none" 
    width="600px" 
    src="/img/blog/kvm-host-high-cpu-fix/twitter-1.png" alt="blog/kvm-host-high-cpu-fix/twitter-1.png">
</div>
<!-- IMAGE END -->


<h3 id="the-solution">The Solution</h3>
<p>
  <a class="text-sky-600 no-underline hover:text-sky-800" href="https://twitter.com/Kroupouk666" target=_blank>@Kroupouk666</a> was kind enough to offer a
  potential solution which involves setting the KVM
  <i class="px-2 py-0.5 font-mono font-semibold rounded bg-zinc-900 text-neutral-50 border border-zinc-900 dark:text-neutral-400 dark:border-neutral-400">halt_poll_ns</i>
 parameter to
  <i class="px-2 py-0.5 font-mono font-semibold rounded bg-zinc-900 text-neutral-50 border border-zinc-900 dark:text-neutral-400 dark:border-neutral-400">0</i>
.
</p>


<!-- IMAGE START -->
<div class="pt-4 pb-6 flex justify-center">
  <img class="bg-white rounded-lg shadow-md shadow-zinc-400 dark:opacity-80 dark:shadow-none" 
    width="600px" 
    src="/img/blog/kvm-host-high-cpu-fix/twitter-2.png" alt="blog/kvm-host-high-cpu-fix/twitter-2.png">
</div>
<!-- IMAGE END -->


<p>
  I run my labs with Vagrant using the libvirt provider and I have been using Vagrant triggers
  to throttle the CPU of these type of hosts that run with very high CPU. This potential solution,
  if it works, is much more agreeable so I figured I'd give it a try. First I checked the existing
  value which was <i class="px-2 py-0.5 font-mono font-semibold rounded bg-zinc-900 text-neutral-50 border border-zinc-900 dark:text-neutral-400 dark:border-neutral-400">200000</i>
 and apparently the default.
</p>


<!-- CODE BLOCK START -->
<div id="code-block" class="pt-2 pb-4">
  <div class="rounded-lg border-4 border-zinc-900 shadow-md shadow-zinc-400 dark:shadow-none">
    <div class="py-1 text-center font-bold font-mono border-b-4 border-zinc-900">
      <span class="">cmd</span>
    </div>
    <div class="font-mono">
      <pre><code class="language-text hljs px-5 dark:opacity-80 rounded-b">cat /sys/module/kvm/parameters/halt_poll_ns

# output
200000</code></pre>
    </div>
  </div>
</div>
<!-- CODE BLOCK END -->



<p>
  Next up I changed the value to <i class="px-2 py-0.5 font-mono font-semibold rounded bg-zinc-900 text-neutral-50 border border-zinc-900 dark:text-neutral-400 dark:border-neutral-400">0</i>
 as suggested.
</p>


<!-- CODE BLOCK START -->
<div id="code-block" class="pt-2 pb-4">
  <div class="rounded-lg border-4 border-zinc-900 shadow-md shadow-zinc-400 dark:shadow-none">
    <div class="py-1 text-center font-bold font-mono border-b-4 border-zinc-900">
      <span class="">cmd</span>
    </div>
    <div class="font-mono">
      <pre><code class="language-text hljs px-5 dark:opacity-80 rounded-b">echo 0 | sudo tee /sys/module/kvm/parameters/halt_poll_ns

# output
0</code></pre>
    </div>
  </div>
</div>
<!-- CODE BLOCK END -->



<p>
  Incredibly it worked! I found that on the vMX and CSR1000v the CPU usage went from 100% on
  2x CPUs down to around 30% which is a huge improvement. Also there was no need to reboot
  the host which was a plus. The below illustrates the difference between the before and after
  CPU usage.
</p>

<h4><b>Before</b></h4>

<!-- IMAGE START -->
<div class="pt-4 pb-6 flex justify-center">
  <img class="bg-white rounded-lg shadow-md shadow-zinc-400 dark:opacity-80 dark:shadow-none" 
    width="900px" 
    src="/img/blog/kvm-host-high-cpu-fix/vmx-cpu-before.svg" alt="blog/kvm-host-high-cpu-fix/vmx-cpu-before.svg">
</div>
<!-- IMAGE END -->


<h4><b>After</b></h4>

<!-- IMAGE START -->
<div class="pt-4 pb-6 flex justify-center">
  <img class="bg-white rounded-lg shadow-md shadow-zinc-400 dark:opacity-80 dark:shadow-none" 
    width="900px" 
    src="/img/blog/kvm-host-high-cpu-fix/vmx-cpu-after.svg" alt="blog/kvm-host-high-cpu-fix/vmx-cpu-after.svg">
</div>
<!-- IMAGE END -->


<p>
  Apparently Cisco provided the solution to <a class="text-sky-600 no-underline hover:text-sky-800" href="https://twitter.com/Kroupouk666" target=_blank>@Kroupouk666</a>
  as a result of him filing a bug.
</p>


<!-- IMAGE START -->
<div class="pt-4 pb-6 flex justify-center">
  <img class="bg-white rounded-lg shadow-md shadow-zinc-400 dark:opacity-80 dark:shadow-none" 
    width="600px" 
    src="/img/blog/kvm-host-high-cpu-fix/twitter-3.png" alt="blog/kvm-host-high-cpu-fix/twitter-3.png">
</div>
<!-- IMAGE END -->


<h3 id="permanent-fix">Permanent Fix</h3>
<p>
  The change will be lost on reboot, to make the change permanent add an
  entry to the modprobe config.
</p>


<!-- CODE BLOCK START -->
<div id="code-block" class="pt-2 pb-4">
  <div class="rounded-lg border-4 border-zinc-900 shadow-md shadow-zinc-400 dark:shadow-none">
    <div class="py-1 text-center font-bold font-mono border-b-4 border-zinc-900">
      <span class="">cmd</span>
    </div>
    <div class="font-mono">
      <pre><code class="language-text hljs px-5 dark:opacity-80 rounded-b">echo "options kvm halt_poll_ns=0" | sudo tee --append /etc/modprobe.d/qemu-system-x86.conf

# output
options kvm halt_poll_ns=0</code></pre>
    </div>
  </div>
</div>
<!-- CODE BLOCK END -->



<h3 id="outro">Outro</h3>
<p>
  The power of the community helped me to solve an issue that has been bugging me for some time.
  Thank you very much to <a class="text-sky-600 no-underline hover:text-sky-800" href="https://twitter.com/showipintbri" target=_blank>@showipintbri</a>
  for asking the question and <a class="text-sky-600 no-underline hover:text-sky-800" href="https://twitter.com/Kroupouk666" target=_blank>@Kroupouk666</a>
  for providing the solution.
</p>



            
  


            
  


            
  
    
  <!-- LINKS START -->
  <div class="pb-2">
    <h3 id="links">Links</h3>
      
        <p class="text-xl">
          <a class="text-sky-600 no-underline hover:text-sky-800" href="https://twitter.com/showipintbri/status/1035899052808912896" target=_blank>https://twitter.com/showipintbri/status/1035899052808912896</a>
        </p>
      
        <p class="text-xl">
          <a class="text-sky-600 no-underline hover:text-sky-800" href="https://twitter.com/Kroupouk666/status/1035930275774115841" target=_blank>https://twitter.com/Kroupouk666/status/1035930275774115841</a>
        </p>
      
        <p class="text-xl">
          <a class="text-sky-600 no-underline hover:text-sky-800" href="https://twitter.com/Kroupouk666/status/1036271575421603842" target=_blank>https://twitter.com/Kroupouk666/status/1036271575421603842</a>
        </p>
      
        <p class="text-xl">
          <a class="text-sky-600 no-underline hover:text-sky-800" href="https://www.redhat.com/archives/vfio-users/2016-April/msg00032.html" target=_blank>https://www.redhat.com/archives/vfio-users/2016-April/msg00032.html</a>
        </p>
      
  </div>
  <!-- LINKS END -->

  


            
  
    
<!-- TAGS START -->
  <div id="tags" class="pb-2">
    <div class="flex justify-center">
      
        <div class=" text-rose-700 hover:text-rose-900 font-semibold italic lowercase tracking-wide">
          <i class="-mr-1.5 text-2xl">#</i>
          <a href="/blog/tag/#linux" class="text-xl">linux</a>        
        </div>
      
    </div>
  </div>
<!-- TAGS END -->

  


            
  
<!-- BLANK PAGE START -->
<div id="blank-page">
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
    <br>
  
</div>
<!-- BLANK PAGE END -->


          </div>
        </div>
        <!-- COLUMN 2 END -->

        <!-- COLUMN 3 START -->
        <div class="invisible md:visible md:col-span-3 max-h-screen sticky top-20">
          
  
    
<!-- TABLE OF CONTENTS START -->
<div id="table-of-contents" class="invisible md:visible h-4/5 overflow-y-auto">
  <div class="">
    <i class="not-italic font-semibold text-xl dark:text-neutral-600">On this page</i>
  </div>
  <div class="">
    
      
        <div class="px-1">
          <a class="text-sky-600 font-normal text-xl no-underline hover:text-sky-800" href="#intro">
            Intro
          </a>
        </div>
      
    
      
        <div class="px-1">
          <a class="text-sky-600 font-normal text-xl no-underline hover:text-sky-800" href="#the-question">
            The Question
          </a>
        </div>
      
    
      
        <div class="px-1">
          <a class="text-sky-600 font-normal text-xl no-underline hover:text-sky-800" href="#the-solution">
            The Solution
          </a>
        </div>
      
    
      
        <div class="px-1">
          <a class="text-sky-600 font-normal text-xl no-underline hover:text-sky-800" href="#permanent-fix">
            Permanent Fix
          </a>
        </div>
      
    
      
        <div class="px-1">
          <a class="text-sky-600 font-normal text-xl no-underline hover:text-sky-800" href="#outro">
            Outro
          </a>
        </div>
      
    
      
        <div class="px-1">
          <a class="text-sky-600 font-normal text-xl no-underline hover:text-sky-800" href="#links">
            Links
          </a>
        </div>
      
    
      
        <div class="px-1">
          <a class="text-sky-600 font-normal text-xl no-underline hover:text-sky-800" href="#tags">
            Tags
          </a>
        </div>
      
      
  </div>
</div>
<!-- TABLE OF CONTENTS END -->

  

        </div>
        <!-- COLUMN 3 END -->

      </div>
      <!-- CONTENT END -->

      <!-- BACK TO TOP START -->
<div id="back-to-top" class="hidden fixed bottom-20 right-16 rounded-full font-semibold text-zinc-900 bg-neutral-400 hover:bg-neutral-100">
  <button type="button" class="">
    <i class="fas fa-arrow-circle-up fa-3x"></i>
  </button>
</div>
<!-- BACK TO TOP END -->
    </div>
  
    <!-- FOOTER START -->
<div id="footer" class="fixed inset-x-0 bottom-0">
  <div class="flex justify-center w-full py-4 bg-zinc-900 shadow-lg">
    <div class="text-center">
      <a class="px-2 font-semibold text-neutral-400 hover:text-neutral-100" href="https://twitter.com/codingpackets" target="_blank"><i class="fab fa-twitter fa-2x"></i></a>
      <a class="px-2 font-semibold text-neutral-400 hover:text-neutral-100" href="https://www.twitch.tv/codingpackets" target="_blank"><i class="fab fa-twitch fa-2x"></i></a>
      <a class="px-2 font-semibold text-neutral-400 hover:text-neutral-100" href="https://github.com/bwks" target="_blank"><i class="fab fa-github fa-2x"></i></a>
      <a class="px-2 font-semibold text-neutral-400 hover:text-neutral-100" href="/blog/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </div>
  </div>
</div>
<!-- FOOTER END -->

  </body>

</html>
